---
name: bdd
description: 이 스킬은 리팩터링 및 기능 개발 시 "외부 행동(External Behavior)"을 보호하도록 강제한다.
---

## 목적
테스트는 내부 구현이 아니라
"외부 행동(External Behavior)"을 보호한다.

리팩터링 시 구조는 바뀔 수 있지만,
행동은 바뀌면 안 된다.


---

## 핵심 원칙

1. 결과를 검증하라.
2. 구현을 검증하지 마라.
3. 사용자 관점에서 테스트하라.
4. 시스템 경계(API)에서 테스트하라.
5. 최종 상태를 기준으로 검증하라.


---

## 무엇을 검증해야 하는가

- HTTP 상태 코드
- 응답 데이터
- 예외 타입
- DB 최종 상태
- 재고, 잔액 등의 실제 수치
- 상태 전이 결과

---

## 무엇을 검증하지 말아야 하는가

- 특정 메서드 호출 여부
- Repository 호출 횟수
- 내부 클래스 구조
- Mock verify 중심 테스트
- private 메서드 동작

---

## 테스트 작성 규칙

- Given / When / Then 구조를 사용한다.
- 하나의 시나리오만 검증한다.
- 의미 있는 테스트 이름을 사용한다.
- 매직 넘버를 피한다.
- 내부 구현 변경에 깨지지 않아야 한다.

---

## 리팩터링 안전 기준

테스트가 통과하면 안전하다.
테스트가 깨지면 행동이 바뀐 것이다.

단위 테스트가 깨져도
인수 테스트가 통과한다면
구현 변경일 가능성이 높다.

---

## 리팩터링 규칙

외부 행동(external behavior)은 절대 변경하지 않는다.

- API 응답 구조, HTTP 상태 코드, 예외 타입 유지
- 비즈니스 결과와 DB 최종 상태 동일해야 함

**리팩터링 시 금지 사항:**
- 트랜잭션 경계 변경
- 예외 타입 변경
- 응답 포맷 변경
- 상태 전이 규칙 변경
- 동작 순서 변경으로 인한 부작용

**자유롭게 개선 가능한 영역:**
- 클래스 책임 분리, 메서드 추출, 도메인 객체 도입
- 서비스 분리, 의존성 방향 수정, 중복 제거, 네이밍 개선

---

## 비즈니스 요구사항

### 1. 선물 보내기

사용자가 상품을 선택하고 수량을 입력하여 선물을 요청하면:
- 선물 요청이 생성되어야 한다
- 재고가 해당 수량만큼 감소해야 한다
- 정상 응답이 반환되어야 한다
- 트랜잭션은 원자적으로 처리되어야 한다

### 2. 재고 부족

재고보다 많은 수량을 요청하면:
- 예외가 발생해야 한다
- 재고는 변경되지 않아야 한다
- 선물 요청은 생성되지 않아야 한다

### 3. 잔액 부족

잔액이 부족한 상태에서 결제를 시도하면:
- 결제가 실패해야 한다
- 잔액은 차감되지 않아야 한다
- 선물은 생성되지 않아야 한다

### 4. 상태 전이 규칙

- 생성된 선물은 취소 가능하다
- 취소 시 재고는 복구되어야 한다
- 잘못된 상태 전이는 허용되지 않는다

### 5. 시스템 경계 기준 보호

테스트에서 반드시 검증해야 할 항목:
- HTTP 상태 코드, 응답 Body
- DB 최종 상태, 재고 수량, 잔액 수치, 선물 상태 값

내부 메서드 호출 여부는 보호 대상이 아니다.
